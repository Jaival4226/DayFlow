{% extends "base.html" %}
{% block title %}My Payroll{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>My Salary Slips</h2>
</div>

<div class="row g-4" id="payrollContainer">
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    const container = document.getElementById('payrollContainer');

    try {
        const response = await fetch('/api/payroll/my-slips', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const slips = await response.json();

        if (slips.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted">No payroll records found.</div>';
            return;
        }

        container.innerHTML = slips.map((slip, index) => {
            const slipId = `payslip-hidden-${index}`;
            
            return `
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-file-invoice-dollar text-primary fa-3x mb-3"></i>
                            <h5 class="fw-bold">${slip.month} ${slip.year}</h5>
                            <small class="text-muted">Generated: ${slip.generated_on}</small>
                        </div>
                        
                        <div class="p-3 bg-light rounded mb-3">
                            <span class="d-block text-muted small text-uppercase">Net Salary</span>
                            <span class="h4 text-primary fw-bold mb-0">₹${slip.net_salary.toLocaleString()}</span>
                        </div>

                        <button class="btn btn-outline-primary w-100" onclick="generatePDF('${slipId}', '${slip.month}', '${slip.year}')">
                            <i class="fas fa-download me-2"></i> Download Slip
                        </button>
                    </div>
                </div>

                <div id="${slipId}" style="display: none;">
                    <div class="p-5" style="border: 2px solid #000;">
                        <div class="text-center border-bottom pb-3 mb-4">
                            <h2 style="color: #4a90e2; font-weight: bold;">DAYFLOW INC.</h2>
                            <p class="text-muted">Official Salary Slip</p>
                            <h4>${slip.month} ${slip.year}</h4>
                        </div>
                        
                        <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" border="1" cellpadding="10">
                            <tr style="background-color: #f8f9fa;">
                                <th colspan="2">Earnings</th>
                                <th colspan="2">Deductions</th>
                            </tr>
                            <tr>
                                <td>Basic Salary</td>
                                <td style="text-align: right;">₹${slip.basic.toLocaleString()}</td>
                                <td>Provident Fund</td>
                                <td style="text-align: right; color: red;">-₹${slip.pf.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>HRA</td>
                                <td style="text-align: right;">₹${slip.hra.toLocaleString()}</td>
                                <td>Professional Tax</td>
                                <td style="text-align: right; color: red;">-₹${slip.pt.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>DA</td>
                                <td style="text-align: right;">₹${slip.da.toLocaleString()}</td>
                                <td>Other Deductions</td>
                                <td style="text-align: right; color: red;">-0.00</td>
                            </tr>
                             <tr>
                                <td>Special Allowance</td>
                                <td style="text-align: right;">₹${slip.medical.toLocaleString()}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr style="font-weight: bold;">
                                <td>Total Earnings</td>
                                <td style="text-align: right;">₹${(slip.basic + slip.hra + slip.da + slip.medical).toLocaleString()}</td>
                                <td>Total Deductions</td>
                                <td style="text-align: right; color: red;">-₹${slip.deductions.toLocaleString()}</td>
                            </tr>
                        </table>
                        
                        <div style="text-align: right; margin-top: 30px;">
                            <span style="font-size: 1.2rem; font-weight: bold;">NET PAYABLE: </span>
                            <span style="font-size: 1.5rem; color: #4a90e2; font-weight: bold;">₹${slip.net_salary.toLocaleString()}</span>
                        </div>
                        
                        <div style="margin-top: 50px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.8rem; color: #666;">
                            <p>This is a system-generated payslip and does not require a signature.</p>
                            <p>Generated on Dayflow HRMS.</p>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');

    } catch (error) {
        console.error(error);
        container.innerHTML = '<p class="text-danger">Failed to load payroll data.</p>';
    }
});

function generatePDF(elementId, month, year) {
    // 1. Clone the hidden element
    const element = document.getElementById(elementId);
    const clone = element.cloneNode(true);
    
    // 2. Make it visible but position it off-screen/overlay to ensure it renders
    clone.style.display = 'block';
    clone.style.width = '700px'; // Set fixed width for PDF consistency
    clone.style.background = 'white';
    
    // 3. Generate PDF
    const opt = {
        margin:       10,
        filename:     `Payslip_${month}_${year}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(clone).save();
}
</script>
{% endblock %}